<project_specification>
  <project_name>linears</project_name>

  <overview>
    A Rust CLI that provides complete coverage of Linear's GraphQL API surface area.
    Schema-driven at compile time: the GraphQL schema is synced from Linear's SDK repo,
    checked in, and used for code generation. Supports queries (list/get/search),
    mutations (CRUD helpers + universal mutate), and multiple output formats with
    table as the default for human-friendly display.
  </overview>

  <technology_stack>
    <language>Rust (2024 edition)</language>
    <cli_framework>clap (derive API)</cli_framework>
    <http_client>reqwest with tokio async runtime</http_client>
    <serialization>
      <json>serde_json</json>
      <yaml>serde_yaml</yaml>
    </serialization>
    <error_handling>
      <library>thiserror (for core errors)</library>
      <boundary>anyhow (for CLI boundary)</boundary>
    </error_handling>
    <graphql_parser>graphql-parser or apollo-parser</graphql_parser>
    <table_rendering>tabled or comfy-table</table_rendering>
    <date_formatting>chrono with chrono-humanize</date_formatting>
    <progress_indicators>indicatif (for spinners)</progress_indicators>
  </technology_stack>

  <prerequisites>
    <environment_setup>
      - Rust toolchain (stable, 1.85+ for 2024 edition)
      - LINEAR_API_KEY environment variable (required for API calls)
      - Optional: LINEAR_ENDPOINT, LINEARS_OUTPUT, LINEARS_WORKSPACE env vars
    </environment_setup>
  </prerequisites>

  <feature_count>127</feature_count>

  <environment_variables>
    <required>
      <var name="LINEAR_API_KEY">Personal API key for Linear authentication</var>
    </required>
    <optional>
      <var name="LINEAR_ENDPOINT">Override default API endpoint (https://api.linear.app/graphql)</var>
      <var name="LINEARS_OUTPUT">Default output format: json|yaml|table|text|ndjson</var>
      <var name="LINEARS_WORKSPACE">Workspace slug or ID (required for multi-workspace API keys)</var>
    </optional>
  </environment_variables>

  <core_features>
    <discovery_commands>
      - linears resources: List all query resources (generated from schema)
      - linears ops: List all mutation operations (generated from schema)
    </discovery_commands>

    <query_commands>
      - linears list [resource] [options]: List entities with pagination/filtering
      - linears get [resource] [id|key]: Get single entity (auto-detects UUID vs key like ENG-123)
      - linears search [resource] [text]: Smart search with fallback strategies
      - linears raw --query [FILE|STRING]: Execute arbitrary GraphQL queries
    </query_commands>

    <mutation_commands>
      - linears create [resource] --input [JSON|YAML]: Create entity via helper
      - linears update [resource] [id|key] --set [JSON|YAML]: Update entity via helper
      - linears delete [resource] [id|key]: Delete entity (if schema supports)
      - linears archive [resource] [id|key]: Archive entity (if schema supports)
      - linears unarchive [resource] [id|key]: Unarchive entity (if schema supports)
      - linears mutate [op] --vars [JSON|YAML]: Universal mutation escape hatch
    </mutation_commands>

    <schema_commands>
      - linears schema info: Display schema version, commit hash, date, permalink
      - linears schema diff: Show diff between local and upstream schema
      - linears schema sync: Fetch and update schema (via xtask for maintainers)
    </schema_commands>

    <global_flags>
      - --out json|yaml|table|text|ndjson: Output format (default: table, env: LINEARS_OUTPUT)
      - --pretty: Pretty-print JSON/YAML output
      - --no-color: Disable colored output
      - --verbose / -v: Show GraphQL query being sent
      - --endpoint [URL]: Override API endpoint
      - --timeout [secs]: Request timeout
    </global_flags>

    <query_options>
      - --first [n]: Limit results (default: 20)
      - --after [cursor]: Pagination cursor (forward)
      - --last [n]: Limit results (backward pagination)
      - --before [cursor]: Pagination cursor (backward)
      - --all: Auto-paginate all results (max 1000 records)
      - --include-archived: Include archived entities
      - --order-by [ENUM]: Sort order (generated per resource)
      - --filter [JSON|YAML]: Inline filter expression
      - --filter-file [path]: Filter from file
      - --preset minimal|default|wide: Field selection preset
      - --select [fields]: Comma-separated scalar fields
      - --expand [relation[:fields]]: One-level relation expansion
    </query_options>

    <mutation_options>
      - --input [JSON|YAML]: Inline input for create
      - --input-file [path]: Input from file for create
      - --set [JSON|YAML]: Inline input for update
      - --set-file [path]: Input from file for update
      - --vars [JSON|YAML]: Variables for mutate
      - --vars-file [path]: Variables from file for mutate
      - --var key=value: Individual variable override
    </mutation_options>

    <stdin_support>
      - --filter -: Read filter from stdin
      - --input -: Read input from stdin
      - --set -: Read set data from stdin
      - --vars -: Read variables from stdin
      - Enables piping: echo '{"title":"New"}' | linears create issue --input -
    </stdin_support>
  </core_features>

  <output_formats>
    <json>
      <envelope>
        - Query list: { "resource", "operation", "pageInfo"?, "nodes": [...] }
        - Query get: { "resource", "operation", "entity": {...} }
        - Search: { "resource", "operation", "strategy", "nodes": [...] }
        - Mutation: { "op", "operation", "result": {...} }
        - Errors: { "error": { "kind", "message", "details"?, "hint"? }, "graphqlErrors"?: [...] }
      </envelope>
    </json>
    <yaml>Same structure as JSON, formatted as YAML</yaml>
    <ndjson>One JSON object per line (for streaming/pipes/LLMs)</ndjson>
    <table>
      - Human-friendly table driven by --preset
      - Columns based on preset (minimal/default/wide)
      - Dates: relative + locale-aware ("2 hours ago", "yesterday", "Jan 11")
      - Colors: minimal, semantic (status/priority), light/dark terminal compatible
    </table>
    <text>Single-entity human-readable text view</text>
  </output_formats>

  <error_handling>
    <exit_codes>
      - 0: Success
      - 1: General/unknown error
      - 2: Auth error (missing/invalid LINEAR_API_KEY)
      - 3: Network error (connection failed, timeout)
      - 4: GraphQL error (valid request, Linear returned errors)
    </exit_codes>
    <retry_behavior>
      - 429 (Rate Limited): Retry after Retry-After header if â‰¤60s, else show reset time and exit
      - 5xx (Server Error): Max 10 retries with exponential backoff + jitter
    </retry_behavior>
    <progress_indicators>
      - Show spinner/progress to stderr only when attached to TTY
      - Silent when output is piped or redirected
    </progress_indicators>
  </error_handling>

  <smart_search>
    <strategy>
      1. Prefer native search query field if schema provides one for that resource
      2. Else generate filter OR-heuristic using resource's filter input type:
         - Exact-first: id, identifier, key, slug (if present)
         - Contains-insensitive: name, title, description (if present)
      3. Else return structured error recommending raw, include detected candidate fields
    </strategy>
    <requirements>
      - Results must be deterministic (query + variables)
      - Snapshot-testable
    </requirements>
  </smart_search>

  <schema_and_codegen>
    <source>
      - URL: https://raw.githubusercontent.com/linear/linear/master/packages/sdk/src/schema.graphql
      - Local: schemas/linear/schema.graphql (checked in)
      - Metadata: schemas/linear/schema.meta.json (commit hash, date, permalink)
    </source>
    <xtask_commands>
      - cargo xtask schema sync: Fetch schema, record commit hash, normalize, write files
      - cargo xtask codegen: Parse SDL, generate Rust code
    </xtask_commands>
    <generated_files>
      - src/generated/resources.rs: Resource enum (clap ValueEnum)
      - src/generated/registry.rs: Query capabilities, presets, expansions
      - src/generated/mutation_ops.rs: MutationOp enum (clap ValueEnum)
      - src/generated/mutation_registry.rs: Op arg metadata, helper mappings
      - src/generated/search_plan.rs: Per-resource search plans
    </generated_files>
    <ci_enforcement>
      - Running schema sync + codegen must produce no git diff
      - Snapshot tests fail on drift
    </ci_enforcement>
  </schema_and_codegen>

  <version_info>
    <linears_version>Display CLI version from Cargo.toml</linears_version>
    <schema_version>
      - Commit hash from schema.meta.json
      - Date synced
      - Permalink to exact schema version on GitHub
    </schema_version>
  </version_info>

  <project_structure>
    <directories>
      - src/main.rs: Entry point, CLI setup
      - src/cli/: Clap command definitions
      - src/generated/: Codegen output (never hand-edited)
      - src/query_builder/: List/get/search query construction
      - src/mutation_builder/: Mutate + helpers, result selection
      - src/client/: HTTP client, retries, backoff, error mapping
      - src/render/: Output formatters (json/yaml/ndjson/table/text)
      - src/validate/: Input validation
      - xtask/: Schema sync and codegen tooling
      - schemas/linear/: Checked-in schema and metadata
      - tests/: Unit, snapshot, and integration tests
    </directories>
  </project_structure>

  <testing_strategy>
    <unit_tests>
      - registry_snapshot: Resources and capabilities derived from schema
      - mutation_ops_snapshot: List of mutation ops + arg metadata
      - query_snapshot_all_resources: Generated query text + variables skeleton per resource
      - search_plan_snapshot: Per-resource plan and produced filter structure
      - mutation_snapshot_selected_ops: Representative mutation documents + variables + selection
    </unit_tests>
    <integration_tests>
      - Mock GraphQL server validates:
        - Authorization header uses LINEAR_API_KEY value
        - Request body matches expected document + variables
        - Retry/backoff behavior on 429/5xx
        - Output formatting stable for all formats
    </integration_tests>
    <live_smoke_tests>
      - Optional, off by default
      - Enabled by env var, requires LINEAR_API_KEY
    </live_smoke_tests>
  </testing_strategy>

  <implementation_phases>
    <phase number="1">
      <title>Project Setup and Schema Sync</title>
      <tasks>
        - Initialize Cargo workspace with main crate and xtask
        - Set up dependencies in Cargo.toml
        - Implement schema sync (fetch, normalize, write)
        - Create schema.meta.json with commit tracking
        - Set up basic CI with clippy/rustfmt
      </tasks>
    </phase>
    <phase number="2">
      <title>Code Generation</title>
      <tasks>
        - Implement SDL parser for schema introspection
        - Generate Resource enum from Query root
        - Generate MutationOp enum from Mutation root
        - Generate registry with per-resource capabilities
        - Generate search plans per resource
        - Set up snapshot tests for generated code
      </tasks>
    </phase>
    <phase number="3">
      <title>CLI Framework</title>
      <tasks>
        - Define clap CLI structure with all commands
        - Implement global flags
        - Wire up environment variable support
        - Implement --version with schema info
        - Set up help text for all commands
      </tasks>
    </phase>
    <phase number="4">
      <title>HTTP Client</title>
      <tasks>
        - Implement GraphQL client with reqwest
        - Add authentication header from LINEAR_API_KEY
        - Implement retry logic for 429 with Retry-After
        - Implement exponential backoff for 5xx
        - Add timeout support
        - Implement progress spinner for TTY
      </tasks>
    </phase>
    <phase number="5">
      <title>Query Commands</title>
      <tasks>
        - Implement list command with pagination
        - Implement get command with ID auto-detection
        - Implement search command with smart strategy
        - Implement raw command for arbitrary queries
        - Wire up all query options (filter, sort, select, expand)
      </tasks>
    </phase>
    <phase number="6">
      <title>Mutation Commands</title>
      <tasks>
        - Implement mutate universal command
        - Implement create helper with input parsing
        - Implement update helper
        - Implement delete/archive/unarchive helpers
        - Add stdin support for all input flags
      </tasks>
    </phase>
    <phase number="7">
      <title>Output Rendering</title>
      <tasks>
        - Implement JSON output with stable envelope
        - Implement YAML output
        - Implement NDJSON output
        - Implement table output with presets
        - Implement text output for single entities
        - Add color support with --no-color override
        - Implement relative date formatting
      </tasks>
    </phase>
    <phase number="8">
      <title>Discovery and Schema Commands</title>
      <tasks>
        - Implement resources command
        - Implement ops command
        - Implement schema info command
        - Implement schema diff command
      </tasks>
    </phase>
    <phase number="9">
      <title>Testing and Polish</title>
      <tasks>
        - Add comprehensive snapshot tests
        - Add integration tests with mock server
        - Add optional live smoke tests
        - Ensure all exit codes work correctly
        - Final error message polish
        - Documentation and README
      </tasks>
    </phase>
  </implementation_phases>

  <success_criteria>
    <functionality>
      - linears resources lists all generated query resources
      - linears ops lists all generated mutation ops
      - list/get/search available when supported by schema
      - Filtering/sorting/pagination flags appear only when supported
      - linears mutate can execute any mutation with variables
      - CRUD helpers work for unambiguous entity mappings
    </functionality>
    <output>
      - Default output is table
      - JSON/YAML/text/NDJSON work consistently
      - LINEARS_OUTPUT env var correctly overrides default
    </output>
    <schema>
      - Schema updates produce deterministic diffs
      - Failing tests guide required updates
      - cargo xtask codegen is idempotent
    </schema>
    <reliability>
      - Correct exit codes for all error types
      - Rate limiting handled gracefully
      - Network errors reported clearly
    </reliability>
  </success_criteria>
</project_specification>
